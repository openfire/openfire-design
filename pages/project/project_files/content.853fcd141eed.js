// Generated by CoffeeScript 1.3.3
(function() {
  var ContentController;

  ContentController = (function() {

    function ContentController() {
      var _this = this;
      this.editDlg = null;
      this.editor = null;
      this.editTmpl = null;
      this.calledFrom = null;
      this.newContent = null;
      this.canEdit = null;
      this.init = function() {
        _this.canEdit = $.openfire.page_vars.can_edit;
        if (_this.canEdit) {
          return _this.initContentEditor();
        }
      };
      this.initContentEditor = function() {
        _this.editDlg = $('#content-editor-dlg');
        if (_this.editDlg && _this.editDlg.length) {
          _this.editDlg.modal({
            show: false
          });
          _this.editTmpl = $('#edit-action-tmpl .edit-action');
          _this.editor = $('#content-editor-textarea');
          $('.of-editable').each(function() {
            return _this.initEditable($(this));
          });
          $('#content-editor-save-btn').click(_this.saveContent);
          return $('#content-editor-cancel-btn').click(_this.closeContentEditor);
        }
      };
      this.initEditable = function(obj) {
        var action;
        action = _this.editTmpl.clone();
        return action.insertBefore(obj).click(function() {
          return _this.startEditContent(obj);
        });
      };
      this.startEditContent = function(obj) {
        var opts;
        opts = {};
        if (obj.hasClass('text-only')) {
          opts.toolbar = false;
        }
        _this.editor.redactor(opts);
        _this.editor.setCode(obj.html());
        _this.calledFrom = obj;
        return _this.editDlg.modal('show');
      };
      this.closeContentEditor = function() {
        _this.editor.redactor().destroyEditor();
        return _this.editDlg.modal('hide');
      };
      this.saveContent = function() {
        var data, field, method, url;
        url = '';
        field = '';
        data = {};
        method = 'PUT';
        if (_this.calledFrom.hasClass('project-content')) {
          url = '/_api/v1/project/' + $.openfire.page_vars.project_id + '/';
          field = _this.calledFrom.attr('id').match(/project-field-(\w+)/)[1];
          data.id = $.openfire.page_vars.project_id;
        }
        if (_this.calledFrom.hasClass('profile-content')) {
          url = '/_api/v1/user_profile/' + $.openfire.page_vars.profile_id + '/';
          field = _this.calledFrom.attr('id').match(/profile-field-(\w+)/)[1];
          data.id = $.openfire.page_vars.profile_id;
        }
        if (_this.calledFrom.hasClass('bbq-content')) {
          url = '/_api/v1/bbq_content/';
          data = 'name=' + _this.calledFrom.attr('id').match(/bbq-field-(\w+)/)[1];
          data += '&content=';
          method = 'POST';
        }
        if (_this.calledFrom.hasClass('text-only')) {
          _this.newContent = $.trim(_this.editor.redactor().getText());
        } else {
          _this.newContent = _this.editor.redactor().getCode();
        }
        if (method === 'PUT') {
          data[field] = _this.newContent;
          return $.ajax({
            type: method,
            url: url,
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            success: _this.contentSaved,
            error: _this.contentSaveError
          });
        } else {
          data += _this.newContent;
          return $.ajax({
            type: method,
            url: url,
            data: data,
            success: _this.contentSaved,
            error: _this.contentSaveError
          });
        }
      };
      this.contentSaved = function(response) {
        _this.editDlg.modal('hide');
        $.simple_alert.alert('New content saved!');
        _this.calledFrom.html(_this.newContent);
        return _this.closeContentEditor();
      };
      this.contentSaveError = function(response) {
        if (response.status === 401) {
          alert('Unauthorized. Are you logged in?');
        }
        return alert('Error: ' + response.statusText + ': ' + response.responseText);
      };
    }

    return ContentController;

  })();

  window.ContentController = ContentController;

  $.openfire.controller_classes.content = ContentController;

}).call(this);
